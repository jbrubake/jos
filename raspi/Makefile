# TODO: add headers as dependencies
# TODO: make the ARMGNU piece cleaner

ARMGNU := aarch64-elf

MODULES  := arch/arm64 drivers fs init kernel mm
# Search for headers in these directories
# You do not need to include directories in
# $(MODULES)
INCLUDES :=

# Include top level sources, headers and any other files
# that should be rolled up in a distro tarball
SRCFILES := 
ASMFILES :=
HDRFILES :=
AUXFILES := 
LDSCRIPT := linker.ld

INCLUDES += $(patsubst %, -I%, $(MODULES))
-include $(patsubst %, %/module.mk, $(MODULES))
OBJFILES := $(patsubst %.c,%.o, \
		$(filter %.c,$(SRCFILES))) \
	    $(patsubst %.S,%.o, \
		$(filter %.S,$(ASMFILES)))
DEPFILES := $(OBJFILES:%.o=%.d)

# Tools
CC      := $(ARMGNU)-gcc
LD      := $(ARMGNU)-ld
OBJCOPY := $(ARMGNU)-objcopy

# Kernel intermediate and final names
BASENAME  := kernel8
KERNELELF := $(BASENAME).elf
KERNELIMG := $(BASENAME).img

# Variables to set distro tarball name
VERSION  := 0.0.1
DISTFILE := $(BASENAME)-$(VERSION).tar.gz

# Flags
CFLAGS  := $(INCLUDES) -Wall -nostdlib -nostartfiles -ffreestanding -mgeneral-regs-only
ASFLAGS := $(INCLUDES)
LDFLAGS := 

COMPILE  := $(CC) $(CFLAGS) -MMD
ASSEMBLE := $(CC) $(ASFLAGS) -MMD
LINK     := $(LD) $(LDFLAGS) -T $(LDSCRIPT)

.PHONY: all \
	clean distclean mostlyclean maintainer-clean \
	TAGS dist check lint docs \
	notes todo fixme xxx

all: $(KERNELIMG)

$(KERNELIMG): $(LDSCRIPT) $(OBJFILES)
	$(LINK) -o $(KERNELELF) $(OBJFILES)
	$(OBJCOPY) $(KERNELELF) -O binary $(KERNELIMG)

%.o : %.c
	$(COMPILE) -c $< -o $@

%.o : %.S
	$(ASSEMBLE) -c $< -o $@

clean:
	@# Delete files generated by 'make all'
	-rm $(OBJFILES) $(OBJFILES:.o=.d) $(KERNELELF) $(KERNELIMG)

distclean: clean
	@# Delete files generated by 'configure' and 'make all'

mostlyclean:
	@# Like clean but may refrain from deleting files you
	@#   normally don't want to compile

maintainer-clean: distclean
	@# Delete everything the makefile can build except
	@#   'configure' and files 'configure' needs
	@echo 'This command is intended for maintainers to use; it'
	@echo 'deletes files that may require special tools to rebuild'

TAGS:
	@# Generate ctags

dist:
	@# Make a distribution tarball
	-tar -cv $(SRCFILES) $(ASMFILES) $(HDRFILES) $(AUXFILES) | gzip -c -9 > $(DISTFILE)

check:
	@# Perform tests

lint:
	@# Run lint

docs:
	@# Generate documentation

notes: todo fixme xxx
	@# Prints out all TODO, FIXME and XXX comments

todo:
	-@for file in $(SRCFILES) $(ASMFILES) $(HDRFILES); do grep -H TODO  $$file | sed -e 's/:.*TODO/: TODO/'; done; true
fixme:
	-@for file in $(SRCFILES) $(ASMFILES) $(HDRFILES); do grep -H FIXME $$file | sed -e 's/:.*FIXME/: FIXME/'; done; true
xxx:
	-@for file in $(SRCFILES) $(ASMFILES) $(HDRFILES); do grep -H XXX   $$file | sed -e 's/:.*XXX/: XXX/'; done; true

run: $(KERNELIMG)
	@qemu-system-aarch64 -M raspi3 -kernel $(KERNELIMG) -serial null -serial stdio -curses $(RUNDEBUG)

-include $(DEPFILES)
